# .github/workflows/generate-projectfilelinks.yml
name: Generate ProjectFileLinks

on:
  workflow_dispatch: {}
  schedule:
    # Every 30 minutes
    - cron: '*/60 * * * *'

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: generate-projectfilelinks
  cancel-in-progress: false

jobs:
  generate-links:
    runs-on: ubuntu-latest
    env:
      USER: ${{ github.repository_owner }}
      REPO: ${{ github.event.repository.name }}
      BRANCH: main
      ROOT: Explorer
      OUT: docs/ProjectFileLinks.txt

    steps:
      - name: Checkout repo (with PAT to allow PR creation)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true
          token: ${{ secrets.GH_PAT }}

      - name: Ensure docs folder exists
        run: mkdir -p docs

      - name: Generate ProjectFileLinks.txt
        run: |
          echo "# Auto-generated ProjectFileLinks.txt" > "$OUT"
          echo "# Generated: $(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> "$OUT"
          echo "" >> "$OUT"
          # Find all .luau files under the designated ROOT folder and write raw URLs
          find "$ROOT" -type f -name "*.luau" | sort | while read -r f; do
            fname=$(basename "$f")
            rel="${f#${ROOT}/}"
            url="https://raw.githubusercontent.com/$USER/$REPO/$BRANCH/$ROOT/$rel"
            printf "%s | %s | %s | %s\n" "$fname" "$rel" "$url" "$(date +%F)" >> "$OUT"
          done
          echo "Wrote $OUT with $(wc -l < $OUT) lines."

      - name: Commit changes (if any)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add "$OUT"
          # If there are no staged changes, exit cleanly
          if git diff --staged --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          git commit -m "chore: regenerate ProjectFileLinks.txt"

      - name: Create Pull Request if changed
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GH_PAT }}
          commit-message: "chore: regenerate ProjectFileLinks.txt"
          title: "chore: regenerate ProjectFileLinks.txt"
          body: |
            Auto-generated update of ProjectFileLinks.txt (contains raw.githubusercontent.com links).
            Please review and merge to update the canonical file.
          base: "main"
          branch: "projectfilelinks/update-${{ github.run_id }}"
          labels: "auto-generated"
          draft: false
